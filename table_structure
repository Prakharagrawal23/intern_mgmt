{"resume":"Resume URL/path is required","address":"Address is required","endDate":"End date is required","batchCode":"batch Code is required","team":"Team selection is required","userName":"User name is required","collegeName":"College name is required","password":"Password is required","major":"Major is required","dob":"Date of birth is required","grade":"Grade is required","startDate":"Start date is required","email":"Email is required","graduatingYear":"Graduating year is required","contactNo":"Contact number is required"}

import React, { useState, useEffect } from "react";
import { registerUser, getAllBatchesPublic } from "../../api/userApi";
import formatError from "../../utils/formatError";
import { useNavigate } from "react-router-dom";
import "../../styles/registerUser.css";

export default function RegisterUser() {
  const [msg, setMsg] = useState("");
  const [batches, setBatches] = useState([]);
  const [currentStep, setCurrentStep] = useState(1);
  const navigate = useNavigate();

  const [form, setForm] = useState({
    userName: "",
    email: "",
    password: "",
    dob: "",
    contactNo: "",
    address: "",
    collegeName: "",
    grade: "",
    major: "",
    team: "",
    batchCode: "",
    startDate: "",
    endDate: "",
    graduatingYear: "",
    resume: "",
    profilePic: "",
  });

  useEffect(() => {
    loadBatches();
  }, []);

  const loadBatches = async () => {
    try {
      const res = await getAllBatchesPublic();
      setBatches(res.data);
    } catch (err) {
      console.error("Failed to load batches:", err);
    }
  };

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleBatchSelect = (e) => {
    const val = Number(e.target.value);
    const selected = batches.find((b) => b.batchCode === val);

    if (!selected) return;

    setForm({
      ...form,
      batchCode: selected.batchCode,
      startDate: selected.startDate?.slice(0, 10),
      endDate: selected.endDate?.slice(0, 10),
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      await registerUser(form);
      setMsg("üéâ User Registered Successfully!");
      setTimeout(() => {
        navigate("/"); // redirect to login
      }, 1800);
    } catch (err) {
      setMsg(formatError(err));
      setTimeout(() => setMsg(""), 2000);
    }
  };

  const goNext = () => setCurrentStep((prev) => Math.min(prev + 1, 3));
  const goBack = () => setCurrentStep((prev) => Math.max(prev - 1, 1));

  const isSuccessMsg = msg.startsWith("üéâ");

  return (
    <div className="register-page">
      <div className="container register-container">
        <div className="register-card">

          {/* BACK TO HOME */}
          <button
            className="back-home-btn"
            onClick={() => navigate("/")}
          >
            ‚Üê Home
          </button>

          <div className="register-header">
            <h2>Intern Application</h2>
            <p>Fill in your details to apply for the internship program.</p>
          </div>

          {/* Stepper */}
          <div className="stepper">
            <div className={`step-item ${currentStep === 1 ? "active" : currentStep > 1 ? "completed" : ""}`}>
              <div className="step-circle">1</div>
              <span className="step-label">Personal Information</span>
            </div>

            <div className={`step-item ${currentStep === 2 ? "active" : currentStep > 2 ? "completed" : ""}`}>
              <div className="step-circle">2</div>
              <span className="step-label">Education</span>
            </div>

            <div className={`step-item ${currentStep === 3 ? "active" : ""}`}>
              <div className="step-circle">3</div>
              <span className="step-label">Uploads</span>
            </div>
          </div>

          {msg && (
            <p className={`alert-msg ${isSuccessMsg ? "success-msg" : "error-msg"}`}>
              {msg}
            </p>
          )}

          <form onSubmit={handleSubmit} className="register-form">

            {/* ================= STEP 1 ================= */}
            {currentStep === 1 && (
              <div className="step-content">

                <div className="section-title">Personal Information</div>

                <div className="field-row">
                  <div className="field">
                    <label>Full Name *</label>
                    <input required name="userName" placeholder="Your full name" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Email *</label>
                    <input required name="email" type="email" placeholder="you@example.com" onChange={handleChange} />
                  </div>
                  <div className="field">
                    <label>Password *</label>
                    <input required name="password" type="password" placeholder="Create password" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Date of Birth *</label>
                    <input required name="dob" type="date" onChange={handleChange} />
                  </div>
                  <div className="field">
                    <label>Contact No *</label>
                    <input required name="contactNo" placeholder="Mobile number" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Address *</label>
                    <input required name="address" placeholder="Current address" onChange={handleChange} />
                  </div>
                </div>
              </div>
            )}

            {/* ================= STEP 2 ================= */}
            {currentStep === 2 && (
              <div className="step-content">
                <div className="section-title">Education & Internship Details</div>

                <div className="field-row">
                  <div className="field">
                    <label>College Name *</label>
                    <input required name="collegeName" placeholder="College / University" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Grade</label>
                    <input name="grade" placeholder="e.g. 8.2 CGPA" onChange={handleChange} />
                  </div>
                  <div className="field">
                    <label>Major</label>
                    <input name="major" placeholder="e.g. Computer Science" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Team (Optional)</label>
                    <input name="team" placeholder="Preferred team" onChange={handleChange} />
                  </div>
                  <div className="field">
                    <label>Graduation Year</label>
                    <input name="graduatingYear" placeholder="2026" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Select Batch *</label>
                    <select
                      required
                      name="batchCode"
                      value={form.batchCode || ""}
                      onChange={handleBatchSelect}
                    >
                      <option value="">Choose a batch</option>
                      {batches.map((b) => (
                        <option key={b.batchCode} value={b.batchCode} disabled={b.availableSeats <= 0}>
                          {b.batchName} | {b.courseName} | Seats: {b.availableSeats}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Start Date</label>
                    <input type="date" name="startDate" value={form.startDate || ""} readOnly />
                  </div>
                  <div className="field">
                    <label>End Date</label>
                    <input type="date" name="endDate" value={form.endDate || ""} readOnly />
                  </div>
                </div>
              </div>
            )}

            {/* ================= STEP 3 ================= */}
            {currentStep === 3 && (
              <div className="step-content">
                <div className="section-title">Uploads</div>

                <div className="field-row">
                  <div className="field">
                    <label>Resume URL</label>
                    <input name="resume" placeholder="Drive / Portfolio link" onChange={handleChange} />
                  </div>
                </div>

                <div className="field-row">
                  <div className="field">
                    <label>Profile Pic URL</label>
                    <input name="profilePic" placeholder="Photo URL link" onChange={handleChange} />
                  </div>
                </div>
              </div>
            )}

            {/* Step Navigation */}
            <div className="step-actions">
              {currentStep > 1 && (
                <button className="btn secondary-btn" type="button" onClick={goBack}>
                  ‚Üê Back
                </button>
              )}

              {currentStep < 3 && (
                <button className="btn next-btn" type="button" onClick={goNext}>
                  Next ‚Üí
                </button>
              )}

              {currentStep === 3 && (
                <button className="btn register-btn" type="submit">
                  Register Now ‚úî
                </button>
              )}
            </div>
          </form>

        </div>
      </div>
    </div>
  );
}


/* PAGE BACKGROUND */
.register-page {
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #fff9f0; /* same family as login */
  padding: 24px;
}

/* Outer container */
.register-container {
  width: 100%;
  max-width: 1100px;
}

/* Card */
.register-card {
  background: #ffffff;
  border-radius: 20px;
  padding: 28px 34px 30px;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.12);
  animation: fadeInReg 0.6s ease-out;
}

/* Header */
.register-header h2 {
  font-size: 26px;
  color: #1f1f2d;
  margin-bottom: 4px;
}

.register-header p {
  font-size: 14px;
  color: #7a7a87;
  margin-bottom: 20px;
}

/* STEPPER */
.stepper {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 22px;
  position: relative;
}

.stepper::before {
  content: "";
  position: absolute;
  top: 50%;
  left: 12%;
  right: 12%;
  height: 2px;
  background: #e3e3ee;
  transform: translateY(-50%);
  z-index: 0;
}

.step-item {
  position: relative;
  z-index: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  flex: 1;
}

.step-item:nth-child(1) {
  align-items: flex-start;
}
.step-item:nth-child(3) {
  align-items: flex-end;
}

.step-circle {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  border: 2px solid #d0d0dd;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #ffffff;
  font-weight: 600;
  font-size: 14px;
  color: #8a8aa0;
  transition: all 0.3s ease;
}

.step-label {
  margin-top: 6px;
  font-size: 13px;
  color: #8a8aa0;
}

/* Active / completed states using login theme colors */
.step-item.active .step-circle {
  background: #f79e3b;
  border-color: #f79e3b;
  color: #ffffff;
  box-shadow: 0 0 0 4px rgba(247, 158, 59, 0.25);
}

.step-item.active .step-label {
  color: #2b2b38;
  font-weight: 600;
}

.step-item.completed .step-circle {
  background: #2ac27b;
  border-color: #2ac27b;
  color: #ffffff;
}

.step-item.completed .step-label {
  color: #3d3d4a;
}

/* ALERT MESSAGE */
.alert-msg {
  padding: 10px 12px;
  border-radius: 8px;
  font-size: 14px;
  margin-bottom: 12px;
}

.success-msg {
  background: #e7ffed;
  color: #0f8b32;
}

.error-msg {
  background: #ffe0e0;
  color: #d8000c;
}

/* FORM */
.register-form {
  margin-top: 8px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  color: #2e2e3a;
  margin-bottom: 14px;
}

/* Rows & fields */
.field-row {
  display: flex;
  gap: 18px;
  margin-bottom: 14px;
}

.field {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.field label {
  font-size: 13px;
  color: #5e5e6c;
  margin-bottom: 4px;
}

.field label span {
  color: #e14848;
}

.field input,
.field select {
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid #d1d1dc;
  font-size: 14px;
  background: #fafafb;
  outline: none;
  transition: border 0.25s ease, box-shadow 0.25s ease, background 0.2s ease;
}

.field input:focus,
.field select:focus {
  border-color: #f79e3b;
  box-shadow: 0 0 0 3px rgba(247, 158, 59, 0.2);
  background: #ffffff;
}

.field small {
  margin-top: 4px;
  font-size: 12px;
  color: #8c8c9b;
}

/* Batch preview box */
.batch-preview {
  margin-top: 10px;
  padding: 10px 12px;
  border-radius: 10px;
  background: #fff7ea;
  border: 1px dashed #f3a846;
  font-size: 13px;
  color: #5a4a33;
}

.batch-preview h4 {
  margin-bottom: 4px;
  font-size: 14px;
}

/* STEP ACTION BUTTONS */
.step-actions {
  margin-top: 18px;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
}

/* Buttons ‚Äì reuse theme similar to login */
.btn {
  padding: 9px 22px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.4px;
  transition: background 0.25s ease, transform 0.15s ease,
    box-shadow 0.25s ease;
}

/* secondary / back */
.secondary-btn {
  background: #f3f3fa;
  color: #4b4b5a;
}

.secondary-btn:hover {
  background: #e3e3f2;
}

/* next */
.next-btn {
  background: #f79e3b;
  color: #ffffff;
  box-shadow: 0 8px 16px rgba(247, 158, 59, 0.35);
}

.next-btn:hover {
  background: #f38a10;
  transform: translateY(-1px);
  box-shadow: 0 12px 22px rgba(247, 158, 59, 0.45);
}

/* final register */
.register-btn {
  background: #2ac27b;
  color: #ffffff;
  box-shadow: 0 8px 18px rgba(42, 194, 123, 0.35);
}

.register-btn:hover {
  background: #1ea565;
  transform: translateY(-1px);
  box-shadow: 0 12px 24px rgba(42, 194, 123, 0.45);
}

/* ANIMATIONS */
@keyframes fadeInReg {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* RESPONSIVE */
@media (max-width: 900px) {
  .register-card {
    padding: 22px 18px 24px;
  }

  .stepper::before {
    left: 18%;
    right: 18%;
  }
}

@media (max-width: 700px) {
  .field-row {
    flex-direction: column;
  }

  .stepper {
    flex-direction: column;
    gap: 8px;
  }

  .stepper::before {
    display: none;
  }

  .step-item,
  .step-item:nth-child(1),
  .step-item:nth-child(3) {
    align-items: flex-start;
  }
}

@media (max-width: 480px) {
  .register-page {
    padding: 10px;
  }

  .register-header h2 {
    font-size: 22px;
  }
}
/* BACK TO HOME BUTTON */
.back-home-btn {
  background: #ffb75e;
  border: none;
  color: #fff;
  font-size: 14px;
  padding: 8px 18px;
  border-radius: 50px;
  cursor: pointer;
  font-weight: 600;
  letter-spacing: 0.4px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
  transition: background 0.3s ease, transform 0.3s ease;
  box-shadow: 0px 6px 18px rgba(243, 152, 46, 0.4);
}

.back-home-btn:hover {
  background: #f3941a;
  transform: translateX(-4px);
}
