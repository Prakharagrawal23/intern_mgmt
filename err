import React, { useState, useContext } from "react";
import { loginApi } from "../../api/authApi";
import { AuthContext } from "../../context/AuthContext";
import { useNavigate } from "react-router-dom";
import "../../styles/login.css";

export default function Login() {
  const { login } = useContext(AuthContext);
  const nav = useNavigate();
  const [form, setForm] = useState({ email: "", password: "" });
  const [err, setErr] = useState("");

  const parseJwtPayload = (token) => {
    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return {
        role: payload.role,
        email: payload.sub || payload.email || "",
        userId: payload.userId, // ðŸ”¥ IMPORTANT LINE
      };
    } catch (e) {
      return { role: null, email: null, userId: null };
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setErr("");

    try {
      const res = await loginApi(form);
      const token = res.data;

      const { role, email, userId } = parseJwtPayload(token);

      if (!role) throw new Error("Invalid token payload");

      login(token, role, email);

      // ðŸ”¥ Store userId for all user requests
      if (userId) localStorage.setItem("userId", userId);

      if (role === "ROLE_ADMIN") nav("/admin/dashboard");
      else if (role === "ROLE_TRAINER") nav("/trainer/dashboard");
      else nav("/user/dashboard");

    } catch (error) {
      console.error(error);
      setErr(error?.response?.data || error.message || "Login failed");
    }
  };

  return (
    <div className="center">
      <form className="form" onSubmit={handleSubmit}>
        <h2>Login</h2>

        {err && <div className="error">{err}</div>}

        <input
          placeholder="Email"
          value={form.email}
          onChange={(e) => setForm({ ...form, email: e.target.value })}
        />
        <input
          placeholder="Password"
          type="password"
          value={form.password}
          onChange={(e) => setForm({ ...form, password: e.target.value })}
        />

        <button className="btn" type="submit">Login</button>

        <div style={{ marginTop: 8 }}>
          <a href="/user/register">Register as User</a>
        </div>
      </form>
    </div>
  );
}
