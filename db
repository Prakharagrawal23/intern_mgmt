import React, { useState, useEffect } from "react";
import { registerUser, getAllBatchesPublic } from "../../api/userApi";
import formatError from "../../utils/formatError";
import "../../styles/registerUser.css"; // make sure this exists

export default function RegisterUser() {
  const [msg, setMsg] = useState("");
  const [batches, setBatches] = useState([]);

  const [form, setForm] = useState({
    userName: "",
    email: "",
    password: "",
    dob: "",
    contactNo: "",
    address: "",
    collegeName: "",
    grade: "",
    major: "",
    team: "",
    batchCode: "",
    startDate: "",
    endDate: "",
    graduatingYear: "",
    resume: "",
    profilePic: "",
  });

  useEffect(() => {
    loadBatches();
  }, []);

  const loadBatches = async () => {
    try {
      const res = await getAllBatchesPublic();
      setBatches(res.data);
    } catch (err) {
      console.error("Failed to load batches:", err);
    }
  };

  const handleChange = (e) => {
    setForm({ ...form, [e.target.name]: e.target.value });
  };

  const handleBatchSelect = (e) => {
    const val = Number(e.target.value);
    const selected = batches.find((b) => b.batchCode === val);

    if (!selected) return;

    setForm({
      ...form,
      batchCode: selected.batchCode,
      startDate: selected.startDate?.slice(0, 10),
      endDate: selected.endDate?.slice(0, 10),
    });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      await registerUser(form);
      setMsg("ðŸŽ‰ User Registered Successfully!");
      setTimeout(() => setMsg(""), 2500);
    } catch (err) {
      setMsg(formatError(err));
    }
  };

  return (
    <div className="container register-container">
      <h2>User Registration</h2>
      {msg && <p className="alert-msg">{msg}</p>}

      <form onSubmit={handleSubmit} className="register-form">

        <input required name="userName" placeholder="Full Name" onChange={handleChange} />

        <input required name="email" placeholder="Email" onChange={handleChange} />

        <input required name="password" type="password" placeholder="Password" onChange={handleChange} />

        <input required name="dob" type="date" onChange={handleChange} />

        <input required name="contactNo" placeholder="Contact No" onChange={handleChange} />

        <input required name="address" placeholder="Address" onChange={handleChange} />

        <input required name="collegeName" placeholder="College Name" onChange={handleChange} />

        <input name="grade" placeholder="Grade" onChange={handleChange} />

        <input name="major" placeholder="Major" onChange={handleChange} />

        <input name="team" placeholder="Team" onChange={handleChange} />

        {/* Batch Dropdown */}
        <select
          name="batchCode"
          value={form.batchCode || ""}
          onChange={handleBatchSelect}
          required
        >
          <option value="">Select Batch</option>
          {batches.map((b) => (
            <option
              key={b.batchCode}
              value={b.batchCode}
              disabled={b.availableSeats <= 0}
            >
              {b.batchName} â€” {b.courseName} | Trainer: {b.trainerName || "N/A"} | Seats: {b.availableSeats}
            </option>
          ))}
        </select>

        {/* Auto-filled Dates */}
        <input name="startDate" type="date" value={form.startDate || ""} readOnly />
        <input name="endDate" type="date" value={form.endDate || ""} readOnly />

        <input name="graduatingYear" placeholder="Graduation Year" onChange={handleChange} />
        <input name="resume" placeholder="Resume URL" onChange={handleChange} />
        <input name="profilePic" placeholder="Profile Pic URL" onChange={handleChange} />

        <button className="btn register-btn">Register</button>
      </form>

      {form.batchCode && (
        <div className="batch-preview">
          <h4>Batch Details</h4>
          <p><strong>Batch:</strong> {form.batchCode}</p>
          <p><strong>Start:</strong> {form.startDate}</p>
          <p><strong>End:</strong> {form.endDate}</p>
        </div>
      )}
    </div>
  );
}
