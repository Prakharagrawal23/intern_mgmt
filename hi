package com.finalproject.internMgmtSystem.controller;

import com.finalproject.internMgmtSystem.dto.FeedbackDto;
import com.finalproject.internMgmtSystem.dto.RegisterUserDto;
import com.finalproject.internMgmtSystem.model.*;
import com.finalproject.internMgmtSystem.repository.BatchDao;
import com.finalproject.internMgmtSystem.service.UserService;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/user")
@CrossOrigin
public class UserController {

	@Autowired
	private UserService userService;

	// User registration
	@PostMapping("/register")
	public User register(@Valid @RequestBody RegisterUserDto dto) {
		return userService.registerUser(dto);
	}

	// Get Tasks
	@GetMapping("/{userId}/tasks")
	public List<Task> getTasks(@PathVariable Long userId) {
		return userService.getTasks(userId);
	}

	// Get Performance
	@GetMapping("/{userId}/performance")
	public List<Performance> getPerformance(@PathVariable Long userId) {
		return userService.getPerformance(userId);
	}

	// Get Stipend History
	@GetMapping("/{userId}/stipends")
	public List<Stipend> getStipends(@PathVariable Long userId) {
		return userService.getStipendHistory(userId);
	}

	// Get Batch Details
	@GetMapping("/batch/{batchCode}")
	public InternshipBatch getBatchDetails(@PathVariable Long batchCode) {
		return userService.getBatchDetails(batchCode);
	}

	// Submit Feedback
	@PostMapping("/feedback")
	public Feedback submitFeedback(@Valid @RequestBody FeedbackDto dto) {
		return userService.submitFeedback(dto);
	}

	// Get Attendance
	@GetMapping("/{userId}/attendance")
	public List<Attendance> getAttendance(@PathVariable Long userId) {
		return userService.getAttendance(userId);
	}
	
	// ðŸ“Œ Add this below other GET endpoints inside UserController

	// Get All Batches (Public Access)
	@GetMapping("/batches")
	public List<InternshipBatch> getAllBatchesPublic() {
	    return BatchDao.findAll();
	}


}
package com.finalproject.internMgmtSystem.service;

import com.finalproject.internMgmtSystem.dto.FeedbackDto;
import com.finalproject.internMgmtSystem.dto.RegisterUserDto;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.exception.UserAlreadyExistsException;
import com.finalproject.internMgmtSystem.model.*;
import com.finalproject.internMgmtSystem.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class UserService {

    @Autowired
    private UserDao userDao;

    @Autowired
    private TaskDao taskDao;

    @Autowired
    private PerformanceDao performanceDao;

    @Autowired
    private StipendDao stipendDao;

    @Autowired
    private BatchDao batchDao;

    @Autowired
    private FeedbackDao feedbackDao;

    @Autowired
    private AttendanceDao attendanceDao;

    @Autowired
    private PasswordEncoder passwordEncoder;

    public User registerUser(RegisterUserDto dto) {

        User exists = userDao.findByEmail(dto.getEmail());
        if (exists != null) {
            throw new UserAlreadyExistsException("User email already exists: " + dto.getEmail());
        }

        InternshipBatch batch = batchDao.findByBatchCode(dto.getBatchCode());
        if (batch == null) {
            throw new ResourceNotFoundException("Batch not found with code: " + dto.getBatchCode());
        }
        if (batch.getAvailableSeats() <= 0) {
            throw new ResourceNotFoundException("No available seats in batch: " + dto.getBatchCode());
        }
        batchDao.decrementAvailableSeats(dto.getBatchCode());

        User user = new User();
        user.setUserName(dto.getUserName());
        user.setEmail(dto.getEmail());
        user.setPassword(passwordEncoder.encode(dto.getPassword()));
        user.setDob(dto.getDob());
        user.setContactNo(dto.getContactNo());
        user.setAddress(dto.getAddress());
        user.setCollegeName(dto.getCollegeName());
        user.setGrade(dto.getGrade());
        user.setMajor(dto.getMajor());
        user.setTeam(dto.getTeam());
        user.setBatchCode(dto.getBatchCode());
        user.setStartDate(dto.getStartDate());
        user.setEndDate(dto.getEndDate());
        user.setGraduatingYear(dto.getGraduatingYear());
        user.setResume(dto.getResume());
        user.setProfilePic(dto.getProfilePic());
        user.setRole("USER");

        return userDao.save(user);
    }

    public List<Task> getTasks(Long userId) {
        return taskDao.findByUserId(userId); // âœ¨ Allow empty list
    }

    public List<Performance> getPerformance(Long userId) {
        return performanceDao.findByUserId(userId); // âœ¨ Allow empty list
    }

    public List<Stipend> getStipendHistory(Long userId) {
        return stipendDao.findByUserId(userId); // âœ¨ Allow empty list
    }

    public InternshipBatch getBatchDetails(Long batchCode) {
        InternshipBatch batch = batchDao.findById(batchCode);
        if (batch == null) {
            throw new ResourceNotFoundException("Batch not found with code: " + batchCode);
        }
        return batch;
    }

    public Feedback submitFeedback(FeedbackDto dto) {
        Feedback f = new Feedback();
        f.setUserId(dto.getUserId());
        f.setUserName(dto.getUserName());
        f.setBatchCode(dto.getBatchCode());
        f.setTrainerName(dto.getTrainerName());
        f.setFeedback(dto.getFeedback());
        f.setRating(dto.getRating());
        return feedbackDao.save(f);
    }

    public List<Attendance> getAttendance(Long userId) {
        return attendanceDao.findByUserId(userId); // âœ¨ Allow empty list
    }
}


package com.finalproject.internMgmtSystem.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.cors.CorsConfigurationSource;

import java.util.List;

@Configuration
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http.csrf(csrf -> csrf.disable());

        // VERY IMPORTANT: enable CORS here
        http.cors(cors -> cors.configurationSource(corsConfigurationSource()));

        http.authorizeHttpRequests(auth -> auth
                .requestMatchers(
                        "/api/auth/login",
                        "/api/user/register"
                ).permitAll()
                .requestMatchers("/api/admin/**").hasAuthority("ROLE_ADMIN")
                .requestMatchers("/api/trainer/**").hasAuthority("ROLE_TRAINER")
                .requestMatchers("/api/user/**").hasAuthority("ROLE_USER")
                .anyRequest().authenticated()
        );

        http.sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
        );

        http.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    // FULL CORS CONFIGURATION FOR SPRING SECURITY
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {

        CorsConfiguration config = new CorsConfiguration();
        config.setAllowedOrigins(List.of("http://localhost:3000"));
        config.setAllowedMethods(List.of("GET", "POST", "PUT", "DELETE", "PATCH", "OPTIONS"));
        config.setAllowedHeaders(List.of("*"));
        config.setExposedHeaders(List.of("Authorization"));
        config.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", config);

        return source;
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
        return config.getAuthenticationManager();
    }
}


package com.finalproject.internMgmtSystem.security;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import org.springframework.stereotype.Component;

import java.security.Key;
import java.util.Date;

@Component
public class JwtUtil {

    private final long EXPIRATION_TIME = 1000 * 60 * 60 * 10;
    private final Key secretKey = Keys.secretKeyFor(SignatureAlgorithm.HS256);

    // USER TOKEN
    public String generateToken(Long userId, String email, String role) {
        return Jwts.builder()
                .setSubject(email)
                .claim("userId", userId)
                .claim("role", role)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(secretKey)
                .compact();
    }

    // TRAINER TOKEN (Trainer Name + Trainer ID added)
    public String generateTrainerToken(Long trainerId, String email, String role, String trainerName) {
        return Jwts.builder()
                .setSubject(email)
                .claim("userId", trainerId)    // REQUIRED BY SPRING SECURITY
                .claim("trainerId", trainerId)
                .claim("trainerName", trainerName)
                .claim("role", role)
                .setIssuedAt(new Date())
                .setExpiration(new Date(System.currentTimeMillis() + EXPIRATION_TIME))
                .signWith(secretKey)
                .compact();
    }

    public String extractEmail(String token) {
        return extractAllClaims(token).getSubject();
    }

    public String extractRole(String token) {
        return extractAllClaims(token).get("role", String.class);
    }

    public Long extractUserId(String token) {
        return extractAllClaims(token).get("userId", Long.class);
    }

    private Claims extractAllClaims(String token) {
        return Jwts.parserBuilder()
                .setSigningKey(secretKey)
                .build()
                .parseClaimsJws(token)
                .getBody();
    }

    public boolean isTokenValid(String token) {
        try {
            extractAllClaims(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}



package com.finalproject.internMgmtSystem.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        final String header = request.getHeader("Authorization");

        if (header == null || !header.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        String token = header.substring(7);

        if (!jwtUtil.isTokenValid(token)) {
            filterChain.doFilter(request, response);
            return;
        }

        Long userId = jwtUtil.extractUserId(token); // â¬… NEW
        String role = jwtUtil.extractRole(token);

        SimpleGrantedAuthority authority = new SimpleGrantedAuthority(role);

        UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(
                        userId, null, List.of(authority)
                );

        SecurityContextHolder.getContext().setAuthentication(authentication);

        filterChain.doFilter(request, response);
    }
}


package com.finalproject.internMgmtSystem.security;

import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.TrainerDao;
import com.finalproject.internMgmtSystem.repository.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class CustomUserDetailsService implements UserDetailsService {

    @Autowired
    private UserDao userDao;

    @Autowired
    private TrainerDao trainerDao;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {

        User user = userDao.findByEmail(email);
        if (user != null) {
            return new org.springframework.security.core.userdetails.User(
                    user.getEmail(),
                    user.getPassword(),
                    List.of(new SimpleGrantedAuthority("ROLE_" + user.getRole()))   // FIXED
            );
        }

        Trainer trainer = trainerDao.findByEmail(email);
        if (trainer != null) {
            return new org.springframework.security.core.userdetails.User(
                    trainer.getEmail(),
                    trainer.getPassword(),
                    List.of(new SimpleGrantedAuthority("ROLE_" + trainer.getRole())) // FIXED
            );
        }

        throw new UsernameNotFoundException("User not found: " + email);
    }
}


package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.InternshipBatch;
import java.util.List;

public interface BatchDao {

    InternshipBatch save(InternshipBatch batch);

    InternshipBatch findById(Long batchCode);

    List<InternshipBatch> findAll();

    List<InternshipBatch> findByTrainerId(Long trainerId);

    void update(InternshipBatch batch);

    void delete(Long batchCode);

    InternshipBatch findByName(String batchName);
    
    InternshipBatch findByBatchCode(Long batchCode);

    void decrementAvailableSeats(Long batchCode);
}



package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.repository.BatchDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class BatchDaoImpl implements BatchDao {

	@Autowired
	private JdbcTemplate jdbcTemplate;

	private RowMapper<InternshipBatch> mapper = (rs, rowNum) -> {
		InternshipBatch b = new InternshipBatch();
		b.setBatchCode(rs.getLong("batch_code"));
		b.setBatchName(rs.getString("batch_name"));
		b.setCourseName(rs.getString("course_name"));
		b.setTrainerId(rs.getLong("trainer_id"));
		b.setStartDate(rs.getDate("start_date"));
		b.setEndDate(rs.getDate("end_date"));
		b.setTotalSeats(rs.getInt("total_seats"));
		b.setAvailableSeats(rs.getInt("available_seats"));
		return b;
	};

	@Override
	public InternshipBatch save(InternshipBatch batch) {
		String sql = """
				    INSERT INTO internship_batches
				    (batch_name, course_name, trainer_id, start_date, end_date, total_seats, available_seats)
				    VALUES (?, ?, ?, ?, ?, ?, ?)
				""";

		jdbcTemplate.update(sql, batch.getBatchName(), batch.getCourseName(), batch.getTrainerId(),
				batch.getStartDate(), batch.getEndDate(), batch.getTotalSeats(), batch.getAvailableSeats());

		Long id = jdbcTemplate.queryForObject("SELECT LAST_INSERT_ID()", Long.class);
		batch.setBatchCode(id);
		return batch;
	}

	@Override
	public InternshipBatch findById(Long batchCode) {
		List<InternshipBatch> list = jdbcTemplate.query("SELECT * FROM internship_batches WHERE batch_code = ?", mapper,
				batchCode);
		return list.isEmpty() ? null : list.get(0);
	}

	@Override
	public List<InternshipBatch> findAll() {
		return jdbcTemplate.query("SELECT * FROM internship_batches", mapper);
	}

	@Override
	public List<InternshipBatch> findByTrainerId(Long trainerId) {
		return jdbcTemplate.query("SELECT * FROM internship_batches WHERE trainer_id = ?", mapper, trainerId);
	}

	@Override
	public void update(InternshipBatch batch) {
		String sql = """
				    UPDATE internship_batches SET batch_name=?, course_name=?, trainer_id=?, start_date=?,
				    end_date=?, total_seats=?, available_seats=? WHERE batch_code=?
				""";

		jdbcTemplate.update(sql, batch.getBatchName(), batch.getCourseName(), batch.getTrainerId(),

				batch.getStartDate(), batch.getEndDate(), batch.getTotalSeats(), batch.getAvailableSeats(),
				batch.getBatchCode());
	}

	@Override
	public void delete(Long batchCode) {
		jdbcTemplate.update("DELETE FROM internship_batches WHERE batch_code = ?", batchCode);
	}

	@Override
	public InternshipBatch findByName(String batchName) {
		List<InternshipBatch> list = jdbcTemplate.query("SELECT * FROM internship_batches WHERE batch_name = ?", mapper,
				batchName);
		return list.isEmpty() ? null : list.get(0);
	}
	
	@Override
	public InternshipBatch findByBatchCode(Long batchCode) {
	    List<InternshipBatch> list = jdbcTemplate.query(
	        "SELECT * FROM internship_batches WHERE batch_code = ?", mapper, batchCode);
	    return list.isEmpty() ? null : list.get(0);
	}

	@Override
	public void decrementAvailableSeats(Long batchCode) {
	    String sql = """
	        UPDATE internship_batches 
	        SET available_seats = available_seats - 1 
	        WHERE batch_code = ? AND available_seats > 0
	    """;
	    jdbcTemplate.update(sql, batchCode);
	}

}
