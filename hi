package com.finalproject.internMgmtSystem.controller;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.service.AdminService;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/admin")
@CrossOrigin
public class AdminController {

    @Autowired
    private AdminService adminService;

    @PostMapping("/trainers")
    public Trainer createTrainer(@Valid @RequestBody RegisterTrainerDto dto) {
        return adminService.registerTrainer(dto);
    }

    @PostMapping("/batches")
    public InternshipBatch createBatch(@Valid @RequestBody BatchDto dto) {
        return adminService.createBatch(dto);
    }

    @PostMapping("/stipend")
    public Stipend giveStipend(@Valid @RequestBody StipendDto dto) {
        return adminService.giveStipend(dto);
    }

    @GetMapping("/users")
    public List<User> getAllUsers() {
        return adminService.getAllUsers();
    }

    @GetMapping("/trainers")
    public List<Trainer> getAllTrainers() {
        return adminService.getAllTrainers();
    }

    @GetMapping("/batches")
    public List<InternshipBatch> getAllBatches() {
        return adminService.getAllBatches();
    }

    // DELETE USER BY EMAIL
    @DeleteMapping("/user/email/{email}")
    public String deleteUserByEmail(@PathVariable String email) {
        adminService.deleteUserByEmail(email);
        return "User deleted successfully with email: " + email;
    }

    // DELETE TRAINER BY EMAIL
    @DeleteMapping("/trainer/email/{email}")
    public String deleteTrainerByEmail(@PathVariable String email) {
        adminService.deleteTrainerByEmail(email);
        return "Trainer deleted successfully with email: " + email;
    }

    // DELETE BATCH BY BATCH NAME
    @DeleteMapping("/batch/name/{batchName}")
    public String deleteBatchByName(@PathVariable String batchName) {
        adminService.deleteBatchByName(batchName);
        return "Batch deleted successfully with name: " + batchName;
    }
}


package com.finalproject.internMgmtSystem.service;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.exception.UserAlreadyExistsException;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.*;
import com.finalproject.internMgmtSystem.util.EmailUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AdminService {

	@Autowired
	private TrainerDao trainerDao;

	@Autowired
	private UserDao userDao;

	@Autowired
	private BatchDao batchDao;

	@Autowired
	private StipendDao stipendDao;

	@Autowired
	private PasswordEncoder passwordEncoder;

	@Autowired
	private EmailUtil emailUtil;

	public Trainer registerTrainer(RegisterTrainerDto dto) {

		Trainer exists = trainerDao.findByEmail(dto.getEmail());
		if (exists != null) {
			throw new UserAlreadyExistsException("Trainer with email already exists: " + dto.getEmail());
		}

		Trainer trainer = new Trainer();
		trainer.setName(dto.getName());
		trainer.setEmail(dto.getEmail());
		trainer.setPassword(passwordEncoder.encode(dto.getPassword()));
		trainer.setContact(dto.getContact());
		trainer.setExperience(dto.getExperience());
		trainer.setSkills(dto.getSkills());
		trainer.setProfilePic(dto.getProfilePic());
		trainer.setBio(dto.getBio());
		trainer.setRole("TRAINER");

		Trainer saved = trainerDao.save(trainer);

		// send email (you already had this util)
		emailUtil.sendEmail(dto.getEmail(), "Trainer Account Created",
				"Hello " + dto.getName() + ",\n\n" + "Your trainer account has been created.\n\n" + "Email: "
						+ dto.getEmail() + "\n" + "Password (temporary): " + dto.getPassword() + "\n\n"
						+ "Regards,\nTeam");

		return saved;
	}

	public InternshipBatch createBatch(BatchDto dto) {
		InternshipBatch batch = new InternshipBatch();

		batch.setBatchName(dto.getBatchName());
		batch.setCourseName(dto.getCourseName());
		batch.setTrainerId(dto.getTrainerId());
		batch.setStartDate(dto.getStartDate());
		batch.setEndDate(dto.getEndDate());
		batch.setTotalSeats(dto.getTotalSeats());
		batch.setAvailableSeats(dto.getAvailableSeats());

		return batchDao.save(batch);
	}

	public Stipend giveStipend(StipendDto dto) {

		User user = userDao.findById(dto.getUserId());
		if (user == null) {
			throw new ResourceNotFoundException("User not found for stipend: " + dto.getUserId());
		}

		Stipend stipend = new Stipend();
		stipend.setUserId(dto.getUserId());
		stipend.setUserName(dto.getUserName());
		stipend.setPaymentMode(dto.getPaymentMode());
		stipend.setAmount(dto.getAmount());

		return stipendDao.save(stipend);
	}

	public List<User> getAllUsers() {
		return userDao.findAll();
	}

	public List<Trainer> getAllTrainers() {
		return trainerDao.findAll();
	}

	public List<InternshipBatch> getAllBatches() {
		return batchDao.findAll();
	}

	public void deleteTrainer(Long id) {
		if (trainerDao.findById(id) == null) {
			throw new ResourceNotFoundException("Trainer not found with ID: " + id);
		}
		trainerDao.deleteById(id);
	}

	public void deleteUser(Long id) {
		if (userDao.findById(id) == null) {
			throw new ResourceNotFoundException("User not found with ID: " + id);
		}
		userDao.deleteById(id);
	}

	// --------- NEW: delete by email/name helpers ----------

	// DELETE USER BY EMAIL
	public void deleteUserByEmail(String email) {
		User user = userDao.findByEmail(email);
		if (user == null) {
			throw new ResourceNotFoundException("User not found with email: " + email);
		}
		userDao.deleteById(user.getUserId());
	}

	// DELETE TRAINER BY EMAIL
	public void deleteTrainerByEmail(String email) {
		Trainer trainer = trainerDao.findByEmail(email);
		if (trainer == null) {
			throw new ResourceNotFoundException("Trainer not found with email: " + email);
		}
		trainerDao.deleteByEmail(email);
	}

	// DELETE BATCH BY NAME
	public void deleteBatchByName(String batchName) {
		InternshipBatch batch = batchDao.findByName(batchName);
		if (batch == null) {
			throw new ResourceNotFoundException("Batch not found with name: " + batchName);
		}
		batchDao.delete(batch.getBatchCode());
	}
}


package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.Stipend;
import java.util.List;

public interface StipendDao {

    Stipend save(Stipend stipend);

    List<Stipend> findByUserId(Long userId);

    List<Stipend> findAll();
}


package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.repository.StipendDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.sql.Timestamp;
import java.util.List;

@Repository
public class StipendDaoImpl implements StipendDao {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private RowMapper<Stipend> mapper = (rs, rowNum) -> {
        Stipend s = new Stipend();
        s.setId(rs.getLong("id"));
        s.setUserId(rs.getLong("user_id"));
        s.setUserName(rs.getString("user_name"));
        s.setPaymentDate(rs.getTimestamp("payment_date"));
        s.setPaymentMode(rs.getString("payment_mode"));
        s.setAmount(rs.getDouble("amount"));
        return s;
    };

    @Override
    public Stipend save(Stipend stipend) {
        String sql = """
            INSERT INTO stipend (user_id, user_name, payment_mode, amount, payment_date)
            VALUES (?, ?, ?, ?, NOW())
        """;

        jdbcTemplate.update(sql,
                stipend.getUserId(),
                stipend.getUserName(),
                stipend.getPaymentMode(),
                stipend.getAmount()
        );

        Long id = jdbcTemplate.queryForObject("SELECT LAST_INSERT_ID()", Long.class);
        stipend.setId(id);
        stipend.setPaymentDate(new Timestamp(System.currentTimeMillis())); // Set date in model
        
        return stipend;
    }


    @Override
    public List<Stipend> findByUserId(Long userId) {
        return jdbcTemplate.query(
                "SELECT * FROM stipend WHERE user_id = ? ORDER BY payment_date DESC",
                mapper,
                userId
        );
    }

    @Override
    public List<Stipend> findAll() {
        return jdbcTemplate.query("SELECT * FROM stipend ORDER BY payment_date DESC", mapper);
    }
}


package com.finalproject.internMgmtSystem.model;

import java.sql.Timestamp;

public class Stipend {

    private Long id;
    private Long userId;
    private String userName;
    private Timestamp paymentDate;
    private String paymentMode;
    private Double amount;

    public Stipend() {}

    public Stipend(Long id, Long userId, String userName, Timestamp paymentDate, String paymentMode, Double amount) {
        this.id = id;
        this.userId = userId;
        this.userName = userName;
        this.paymentDate = paymentDate;
        this.paymentMode = paymentMode;
        this.amount = amount;
    }

    // Getters & Setters
    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public Long getUserId() { return userId; }
    public void setUserId(Long userId) { this.userId = userId; }

    public String getUserName() { return userName; }
    public void setUserName(String userName) { this.userName = userName; }

    public Timestamp getPaymentDate() { return paymentDate; }
    public void setPaymentDate(Timestamp paymentDate) { this.paymentDate = paymentDate; }

    public String getPaymentMode() { return paymentMode; }
    public void setPaymentMode(String paymentMode) { this.paymentMode = paymentMode; }

    public Double getAmount() { return amount; }
    public void setAmount(Double amount) { this.amount = amount; }
}


package com.finalproject.internMgmtSystem.dto;

import jakarta.validation.constraints.*;

public class StipendDto {

	@NotNull(message = "User ID is required")
	private Long userId;

	@NotBlank(message = "User name is required")
	private String userName;

	@NotBlank(message = "Payment mode is required")
	private String paymentMode;

	@NotNull(message = "Amount is required")
	@DecimalMin(value = "1.0", message = "Amount must be greater than 0")
	private Double amount;

	public StipendDto() {
	}

	public StipendDto(@NotNull(message = "User ID is required") Long userId,
			@NotBlank(message = "User name is required") String userName,
			@NotBlank(message = "Payment mode is required") String paymentMode,
			@NotNull(message = "Amount is required") @DecimalMin(value = "1.0", message = "Amount must be greater than 0") Double amount) {
		super();
		this.userId = userId;
		this.userName = userName;
		this.paymentMode = paymentMode;
		this.amount = amount;
	}

	public Long getUserId() {
		return userId;
	}

	public void setUserId(Long userId) {
		this.userId = userId;
	}

	public String getUserName() {
		return userName;
	}

	public void setUserName(String userName) {
		this.userName = userName;
	}

	public String getPaymentMode() {
		return paymentMode;
	}

	public void setPaymentMode(String paymentMode) {
		this.paymentMode = paymentMode;
	}

	public Double getAmount() {
		return amount;
	}

	public void setAmount(Double amount) {
		this.amount = amount;
	}

	// getters & setters
}

mysql> select * from stipend;
+----+---------+----------------+---------------------+---------------+------------+
| id | user_id | user_name      | payment_date        | payment_mode  | amount     |
+----+---------+----------------+---------------------+---------------+------------+
|  1 |       1 | Prakhar        | 2025-11-20 21:27:09 | Bank Transfer |    5000.00 |
|  2 |       2 | Rohan          | 2025-11-20 21:27:09 | UPI           |    6000.00 |
|  3 |      13 | Rohit Sharma2  | 2025-11-25 00:14:34 | UPI           |       5.00 |
|  4 |      14 | mayank agrawal | 2025-11-28 17:14:35 | UPI           | 1400000.00 |

import React, { useEffect, useState } from "react";
import { getUserStipends } from "../../api/userApi";
import Navbar from "../../components/Navbar";
import Sidebar from "../../components/Sidebar";
import formatDate from "../../utils/formatDate";

export default function UserStipends() {
  const userId = localStorage.getItem("userId");
  const [data, setData] = useState([]);

  useEffect(() => {
    if (!userId) return;
    getUserStipends(userId).then(res => setData(res.data)).catch(console.error);
  }, [userId]);

  return (
    <div className="layout">
      <Navbar />
      <Sidebar items={[{ to: "/user/dashboard", label: "Dashboard" }]} />
      <div className="main">
        <h3>My Stipends</h3>
        {data.length === 0 ? "No stipend records" :
          <table className="table">
            <thead><tr><th>Amount</th><th>Mode</th><th>Date</th></tr></thead>
            <tbody>
              {data.map(s => (
                <tr key={s.stipendId}>
                  <td>{s.amount}</td>
                  <td>{s.paymentMode}</td>
                  <td>{formatDate(s.date)}</td>
                </tr>
              ))}
            </tbody>
          </table>
        }
      </div>
    </div>
  );
}
export default function formatDate(raw) {
  if (!raw) return "N/A";

  try {
    // If valid ISO date â†’ format directly
    const d = new Date(raw);
    if (!isNaN(d.getTime())) {
      return d.toLocaleDateString("en-IN");
    }

    // If backend sends dd-MM-yyyy format â†’ manually convert
    const parts = raw.split("-");
    if (parts.length === 3) {
      const [day, month, year] = parts;
      const fixed = new Date(`${year}-${month}-${day}`);
      return fixed.toLocaleDateString("en-IN");
    }
  } catch {
    return "Invalid Date";
  }

  return "Invalid Date";
}
import React, { useState, useContext } from "react";
import { loginApi } from "../../api/authApi";
import { AuthContext } from "../../context/AuthContext";
import { useNavigate } from "react-router-dom";
import "../../styles/login.css";

export default function Login() {
  const { login } = useContext(AuthContext);
  const nav = useNavigate();
  const [form, setForm] = useState({ email: "", password: "" });
  const [err, setErr] = useState("");

  const parseJwtPayload = (token) => {
    try {
      const payload = JSON.parse(atob(token.split(".")[1]));
      return {
        role: payload.role,
        email: payload.sub || payload.email || "",
        userId: payload.userId, // ðŸ”¥ IMPORTANT LINE
      };
    } catch (e) {
      return { role: null, email: null, userId: null };
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setErr("");

    try {
      const res = await loginApi(form);
      const token = res.data;

      const { role, email, userId } = parseJwtPayload(token);

      if (!role) throw new Error("Invalid token payload");

      login(token, role, email);

      // ðŸ”¥ Store userId for all user requests
      if (userId) localStorage.setItem("userId", userId);

      if (role === "ROLE_ADMIN") nav("/admin/dashboard");
      else if (role === "ROLE_TRAINER") nav("/trainer/dashboard");
      else nav("/user/dashboard");

    } catch (error) {
      console.error(error);
      setErr(error?.response?.data || error.message || "Login failed");
    }
  };

  return (
    <div className="center">
      <form className="form" onSubmit={handleSubmit}>
        <h2>Login</h2>

        {err && <div className="error">{err}</div>}

        <input
          placeholder="Email"
          value={form.email}
          onChange={(e) => setForm({ ...form, email: e.target.value })}
        />
        <input
          placeholder="Password"
          type="password"
          value={form.password}
          onChange={(e) => setForm({ ...form, password: e.target.value })}
        />

        <button className="btn" type="submit">Login</button>

        <div style={{ marginTop: 8 }}>
          <a href="/user/register">Register as User</a>
        </div>
      </form>
    </div>
  );
}

