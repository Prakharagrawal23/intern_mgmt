 select * from trainers;
+------------+-----------------+------------------------+--------------------------------------------------------------+------------+------------+--------------------------+-------------+-----------------------+---------+---------------------+
| trainer_id | name            | email                  | password                                                     | contact    | experience | skills                   | profile_pic | bio                   | role    | created_at          |
+------------+-----------------+------------------------+--------------------------------------------------------------+------------+------------+--------------------------+-------------+-----------------------+---------+---------------------+
|          1 | Ram Kumar       | ram.trainer@gmail.com  | $2a$10$JDEuSRh4AcG0l2U1BjQVgO4h1.xZ9vq5P1XRg8Mm1Nn.4y2mauCGe | 9876543210 |          5 | Java, Spring Boot, MySQL | ram.jpg     | Senior Java Trainer   | TRAINER | 2025-11-22 15:42:13 |
|          2 | Amit Verma      | amit.trainer@gmail.com | $2a$10$JDEuSRh4AcG0l2U1BjQVgO4h1.xZ9vq5P1XRg8Mm1Nn.4y2mauCGe | 9898989898 |          8 | Python, Django, ML       | amit.png    | Python & ML Mentor    | TRAINER | 2025-11-22 15:42:13 |
|          3 | prakhar agrawal | prakhar@gmail.com      | $2a$10$Eroa1vqaonTEQdxaFdMD0.zhSZ7dcTau7cPqWoVs..6AAckjYMT2C | 9898983298 |          4 | python dev               | prakhar.jpg | Senior python Trainer | TRAINER | 2025-11-22 15:42:13 |
|          4 | aryan           | aryanr@gmail.com       | $2a$10$HNZlDQ.xVKokNxakG70LYOUcf21k0Yyyu/BSsFw1mBSitpmKYZXYC | 98989298   |          1 | sleeping                 | aryan.jpg   | Senior python Trainer | TRAINER | 2025-11-22 15:55:24 |
+------------+-----------------+------------------------+--------------------------------------------------------------+------------+------------+--------------------------+-------------+-----------------------+---------+---------------------+

package com.finalproject.internMgmtSystem.service;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.exception.UserAlreadyExistsException;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.*;
import com.finalproject.internMgmtSystem.util.EmailUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AdminService {

    @Autowired
    private TrainerDao trainerDao;

    @Autowired
    private UserDao userDao;

    @Autowired
    private BatchDao batchDao;

    @Autowired
    private StipendDao stipendDao;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private EmailUtil emailUtil;

    public Trainer registerTrainer(RegisterTrainerDto dto) {

        Trainer exists = trainerDao.findByEmail(dto.getEmail());
        if (exists != null) {
            throw new UserAlreadyExistsException("Trainer with email already exists: " + dto.getEmail());
        }

        Trainer trainer = new Trainer();
        trainer.setName(dto.getName());
        trainer.setEmail(dto.getEmail());
        trainer.setPassword(passwordEncoder.encode(dto.getPassword()));
        trainer.setContact(dto.getContact());
        trainer.setExperience(dto.getExperience());
        trainer.setSkills(dto.getSkills());
        trainer.setProfilePic(dto.getProfilePic());
        trainer.setBio(dto.getBio());
        trainer.setRole("TRAINER");

        Trainer saved = trainerDao.save(trainer);

        emailUtil.sendEmail(dto.getEmail(),
                "Trainer Account Created",
                "Hello " + dto.getName() + "\nYour trainer account has been created.");

        return saved;
    }

    public InternshipBatch createBatch(BatchDto dto) {
        InternshipBatch batch = new InternshipBatch();

        batch.setBatchName(dto.getBatchName());
        batch.setCourseName(dto.getCourseName());
        batch.setTrainerId(dto.getTrainerId());
        batch.setStartDate(dto.getStartDate());
        batch.setEndDate(dto.getEndDate());
        batch.setTotalSeats(dto.getTotalSeats());
        batch.setAvailableSeats(dto.getAvailableSeats());

        return batchDao.save(batch);
    }

    public Stipend giveStipend(StipendDto dto) {

        User user = userDao.findById(dto.getUserId());
        if (user == null) {
            throw new ResourceNotFoundException("User not found for stipend: " + dto.getUserId());
        }

        Stipend stipend = new Stipend();
        stipend.setUserId(dto.getUserId());
        stipend.setUserName(dto.getUserName());
        stipend.setPaymentMode(dto.getPaymentMode());
        stipend.setAmount(dto.getAmount());

        return stipendDao.save(stipend);
    }

    public List<User> getAllUsers() {
        return userDao.findAll();
    }

    public List<Trainer> getAllTrainers() {
        return trainerDao.findAll();
    }

    public List<InternshipBatch> getAllBatches() {
        return batchDao.findAll();
    }

    public void deleteTrainer(Long id) {
        if (trainerDao.findById(id) == null) {
            throw new ResourceNotFoundException("Trainer not found with ID: " + id);
        }
        trainerDao.deleteById(id);
    }

    public void deleteUser(Long id) {
        if (userDao.findById(id) == null) {
            throw new ResourceNotFoundException("User not found with ID: " + id);
        }
        userDao.deleteById(id);
    }
}

package com.finalproject.internMgmtSystem.controller;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.service.AdminService;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/admin")
@CrossOrigin
public class AdminController {

    @Autowired
    private AdminService adminService;

    // Register Trainer
    @PostMapping("/trainers")
    public Trainer createTrainer(@Valid @RequestBody RegisterTrainerDto dto) {
        return adminService.registerTrainer(dto);
    }

    // Create Batch
    @PostMapping("/batches")
    public InternshipBatch createBatch(@Valid @RequestBody BatchDto dto) {
        return adminService.createBatch(dto);
    }

    // Give Stipend
    @PostMapping("/stipend")
    public Stipend giveStipend(@Valid @RequestBody StipendDto dto) {
        return adminService.giveStipend(dto);
    }

    // View all users
    @GetMapping("/users")
    public List<User> getAllUsers() {
        return adminService.getAllUsers();
    }

    // View all trainers
    @GetMapping("/trainers")
    public List<Trainer> getAllTrainers() {
        return adminService.getAllTrainers();
    }

    // View all batches
    @GetMapping("/batches")
    public List<InternshipBatch> getAllBatches() {
        return adminService.getAllBatches();
    }

    // Delete trainer
    @DeleteMapping("/trainer/{trainerId}")
    public String deleteTrainer(@PathVariable Long trainerId) {
        adminService.deleteTrainer(trainerId);
        return "Trainer deleted successfully";
    }

    // Delete user
    @DeleteMapping("/user/{userId}")
    public String deleteUser(@PathVariable Long userId) {
        adminService.deleteUser(userId);
        return "User deleted successfully";
    }
}

package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.repository.BatchDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class BatchDaoImpl implements BatchDao {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private RowMapper<InternshipBatch> mapper = (rs, rowNum) -> {
        InternshipBatch b = new InternshipBatch();
        b.setBatchCode(rs.getLong("batch_code"));
        b.setBatchName(rs.getString("batch_name"));
        b.setCourseName(rs.getString("course_name"));
        b.setTrainerId(rs.getLong("trainer_id"));
        b.setStartDate(rs.getDate("start_date"));
        b.setEndDate(rs.getDate("end_date"));
        b.setTotalSeats(rs.getInt("total_seats"));
        b.setAvailableSeats(rs.getInt("available_seats"));
        return b;
    };

    @Override
    public InternshipBatch save(InternshipBatch batch) {
        String sql = """
            INSERT INTO internship_batches 
            (batch_name, course_name, trainer_id, start_date, end_date, total_seats, available_seats)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        """;

        jdbcTemplate.update(sql,
                batch.getBatchName(),
                batch.getCourseName(),
                batch.getTrainerId(),
                batch.getStartDate(),
                batch.getEndDate(),
                batch.getTotalSeats(),
                batch.getAvailableSeats()
        );

        Long id = jdbcTemplate.queryForObject("SELECT LAST_INSERT_ID()", Long.class);
        batch.setBatchCode(id);
        return batch;
    }

    @Override
    public InternshipBatch findById(Long batchCode) {
        List<InternshipBatch> list = jdbcTemplate.query(
                "SELECT * FROM internship_batches WHERE batch_code = ?",
                mapper,
                batchCode
        );
        return list.isEmpty() ? null : list.get(0);
    }

    @Override
    public List<InternshipBatch> findAll() {
        return jdbcTemplate.query("SELECT * FROM internship_batches", mapper);
    }

    @Override
    public List<InternshipBatch> findByTrainerId(Long trainerId) {
        return jdbcTemplate.query(
                "SELECT * FROM internship_batches WHERE trainer_id = ?",
                mapper,
                trainerId
        );
    }

    @Override
    public void update(InternshipBatch batch) {
        String sql = """
            UPDATE internship_batches SET batch_name=?, course_name=?, trainer_id=?, start_date=?, 
            end_date=?, total_seats=?, available_seats=? WHERE batch_code=?
        """;

        jdbcTemplate.update(sql,
                batch.getBatchName(),
                batch.getCourseName(),
                batch.getTrainerId(),
                batch.getStartDate(),
                batch.getEndDate(),
                batch.getTotalSeats(),
                batch.getAvailableSeats(),
                batch.getBatchCode()
        );
    }

    @Override
    public void delete(Long batchCode) {
        jdbcTemplate.update("DELETE FROM internship_batches WHERE batch_code = ?", batchCode);
    }
}


package com.finalproject.internMgmtSystem.security;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
public class SecurityConfig {

    @Autowired
    private JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {

        http
            .csrf(csrf -> csrf.disable())
            .authorizeHttpRequests(auth -> auth
                // PUBLIC ENDPOINTS
                .requestMatchers(
                        "/api/auth/login",
                        "/api/user/register",
                        "/api/auth/create-admin"     // TEMPORARY â†’ remove after creating admin
                ).permitAll()

                // ROLE-BASED ENDPOINTS
                .requestMatchers("/api/admin/**").hasAuthority("ADMIN")
                .requestMatchers("/api/trainer/**").hasAuthority("TRAINER")
                .requestMatchers("/api/user/**").hasAuthority("USER")

                .anyRequest().authenticated()
            )
            .sessionManagement(session ->
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            );

        // ADD JWT FILTER BEFORE SPRING'S DEFAULT AUTH FILTER
        http.addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();   // generates & validates BCrypt passwords
    }

    @Bean
    public AuthenticationManager authenticationManager(AuthenticationConfiguration config)
            throws Exception {
        return config.getAuthenticationManager();
    }
}
package com.finalproject.internMgmtSystem.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response,
                                    FilterChain filterChain)
            throws ServletException, IOException {

        final String header = request.getHeader("Authorization");

        if (header == null || !header.startsWith("Bearer ")) {
            filterChain.doFilter(request, response);
            return;
        }

        String token = header.substring(7);

        if (!jwtUtil.isTokenValid(token)) {
            filterChain.doFilter(request, response);
            return;
        }

        String email = jwtUtil.extractEmail(token);
        String role  = jwtUtil.extractRole(token);

        // Set authorities directly from JWT
        SimpleGrantedAuthority authority = new SimpleGrantedAuthority(role);

        UsernamePasswordAuthenticationToken authentication =
                new UsernamePasswordAuthenticationToken(
                        email, null, List.of(authority)
                );

        SecurityContextHolder.getContext().setAuthentication(authentication);

        filterChain.doFilter(request, response);
    }
}

