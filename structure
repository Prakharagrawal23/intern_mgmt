package com.finalproject.internMgmtSystem.controller;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.service.AdminService;
import jakarta.validation.Valid;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/admin")
@CrossOrigin
public class AdminController {

    @Autowired
    private AdminService adminService;

    @PostMapping("/trainers")
    public Trainer createTrainer(@Valid @RequestBody RegisterTrainerDto dto) {
        return adminService.registerTrainer(dto);
    }

    @PostMapping("/batches")
    public InternshipBatch createBatch(@Valid @RequestBody BatchDto dto) {
        return adminService.createBatch(dto);
    }

    @PostMapping("/stipend")
    public Stipend giveStipend(@Valid @RequestBody StipendDto dto) {
        return adminService.giveStipend(dto);
    }

    @GetMapping("/users")
    public List<User> getAllUsers() {
        return adminService.getAllUsers();
    }

    @GetMapping("/trainers")
    public List<Trainer> getAllTrainers() {
        return adminService.getAllTrainers();
    }

    @GetMapping("/batches")
    public List<InternshipBatch> getAllBatches() {
        return adminService.getAllBatches();
    }
    
 // DELETE USER BY EMAIL
    @DeleteMapping("/user/email/{email}")
    public String deleteUserByEmail(@PathVariable String email) {
        adminService.deleteUserByEmail(email);
        return "User deleted successfully with email: " + email;
    }

    // DELETE TRAINER BY EMAIL
    @DeleteMapping("/trainers/email/{email}")
    public String deleteTrainerByEmail(@PathVariable String email) {
        adminService.deleteTrainerByEmail(email);
        return "Trainer deleted successfully with email: " + email;
    }

//     DELETE BATCH BY BATCH NAME
    @DeleteMapping("/batch/name/{batchName}")
    public String deleteBatchByName(@PathVariable String batchName) {
        adminService.deleteBatchByName(batchName);
        return "Batch deleted successfully with batch name: " + batchName;
    }

}


package com.finalproject.internMgmtSystem.service;

import com.finalproject.internMgmtSystem.dto.BatchDto;
import com.finalproject.internMgmtSystem.dto.RegisterTrainerDto;
import com.finalproject.internMgmtSystem.dto.StipendDto;
import com.finalproject.internMgmtSystem.exception.ResourceNotFoundException;
import com.finalproject.internMgmtSystem.exception.UserAlreadyExistsException;
import com.finalproject.internMgmtSystem.model.InternshipBatch;
import com.finalproject.internMgmtSystem.model.Stipend;
import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.*;
import com.finalproject.internMgmtSystem.util.EmailUtil;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class AdminService {

    @Autowired
    private TrainerDao trainerDao;

    @Autowired
    private UserDao userDao;

    @Autowired
    private BatchDao batchDao;

    @Autowired
    private StipendDao stipendDao;

    @Autowired
    private PasswordEncoder passwordEncoder;

    @Autowired
    private EmailUtil emailUtil;

    public Trainer registerTrainer(RegisterTrainerDto dto) {

        Trainer exists = trainerDao.findByEmail(dto.getEmail());
        if (exists != null) {
            throw new UserAlreadyExistsException("Trainer with email already exists: " + dto.getEmail());
        }

        Trainer trainer = new Trainer();
        trainer.setName(dto.getName());
        trainer.setEmail(dto.getEmail());
        trainer.setPassword(passwordEncoder.encode(dto.getPassword()));
        trainer.setContact(dto.getContact());
        trainer.setExperience(dto.getExperience());
        trainer.setSkills(dto.getSkills());
        trainer.setProfilePic(dto.getProfilePic());
        trainer.setBio(dto.getBio());
        trainer.setRole("TRAINER");

        Trainer saved = trainerDao.save(trainer);

        emailUtil.sendEmail(
        	    dto.getEmail(),
        	    "Trainer Account Created",
        	    "Hello " + dto.getName() + ",\n\n" +
        	    "We are excited to inform you that your trainer account has been successfully created.\n\n" +
        	    "You can log in using the following credentials:\n" +
        	    "Email: " + dto.getEmail() + "\n" +
        	    "Password: " + dto.getPassword() + "\n\n" +
        	    "Please keep your login details secure.\n\n" +
        	    "Thank you,\n" +
        	    "Intern Management System Team"
        	);

        return saved;
    }

    public InternshipBatch createBatch(BatchDto dto) {
        InternshipBatch batch = new InternshipBatch();

        batch.setBatchName(dto.getBatchName());
        batch.setCourseName(dto.getCourseName());
        batch.setTrainerId(dto.getTrainerId());
        batch.setStartDate(dto.getStartDate());
        batch.setEndDate(dto.getEndDate());
        batch.setTotalSeats(dto.getTotalSeats());
        batch.setAvailableSeats(dto.getAvailableSeats());

        return batchDao.save(batch);
    }

    public Stipend giveStipend(StipendDto dto) {

        User user = userDao.findById(dto.getUserId());
        if (user == null) {
            throw new ResourceNotFoundException("User not found for stipend: " + dto.getUserId());
        }

        Stipend stipend = new Stipend();
        stipend.setUserId(dto.getUserId());
        stipend.setUserName(dto.getUserName());
        stipend.setPaymentMode(dto.getPaymentMode());
        stipend.setAmount(dto.getAmount());

        return stipendDao.save(stipend);
    }

    public List<User> getAllUsers() {
        return userDao.findAll();
    }

    public List<Trainer> getAllTrainers() {
        return trainerDao.findAll();
    }

    public List<InternshipBatch> getAllBatches() {
        return batchDao.findAll();
    }

    public void deleteTrainer(Long id) {
        if (trainerDao.findById(id) == null) {
            throw new ResourceNotFoundException("Trainer not found with ID: " + id);
        }
        trainerDao.deleteById(id);
    }

    public void deleteUser(Long id) {
        if (userDao.findById(id) == null) {
            throw new ResourceNotFoundException("User not found with ID: " + id);
        }
        userDao.deleteById(id);
    }
    
 // DELETE USER BY EMAIL
    public void deleteUserByEmail(String email) {
        User user = userDao.findByEmail(email);
        if (user == null) {
            throw new ResourceNotFoundException("User not found with email: " + email);
        }
        userDao.deleteById(user.getUserId());
    }

    // DELETE TRAINER BY EMAIL
    public void deleteTrainerByEmail(String email) {
        Trainer trainer = trainerDao.findByEmail(email);
        if (trainer == null) {
            throw new ResourceNotFoundException("Trainer not found with email: " + email);
        }
        trainerDao.deleteByEmail(email);
    }

    // DELETE BATCH BY NAME
    public void deleteBatchByName(String batchName) {
        InternshipBatch batch = batchDao.findByName(batchName);
        if (batch == null) {
            throw new ResourceNotFoundException("Batch not found with name: " + batchName);
        }
        batchDao.delete(batch.getBatchCode());
    }

}


package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.Trainer;
import com.finalproject.internMgmtSystem.repository.TrainerDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class TrainerDaoImpl implements TrainerDao {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private RowMapper<Trainer> mapper = (rs, rowNum) -> {
        Trainer t = new Trainer();
        t.setTrainerId(rs.getLong("trainer_id"));
        t.setName(rs.getString("name"));
        t.setEmail(rs.getString("email"));
        t.setPassword(rs.getString("password"));
        t.setContact(rs.getString("contact"));
        t.setExperience(rs.getString("experience"));
        t.setSkills(rs.getString("skills"));
        t.setProfilePic(rs.getString("profile_pic"));
        t.setBio(rs.getString("bio"));
        t.setRole(rs.getString("role"));
        t.setCreatedAt(rs.getTimestamp("created_at"));
        return t;
    };

    @Override
    public Trainer save(Trainer trainer) {
        String sql = "INSERT INTO trainers (name, email, password, contact, experience, skills, profile_pic, bio, role) "
                   + "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

        jdbcTemplate.update(sql,
                trainer.getName(),
                trainer.getEmail(),
                trainer.getPassword(),
                trainer.getContact(),
                trainer.getExperience(),
                trainer.getSkills(),
                trainer.getProfilePic(),
                trainer.getBio(),
                trainer.getRole()
        );

        Long id = jdbcTemplate.queryForObject("SELECT LAST_INSERT_ID()", Long.class);
        trainer.setTrainerId(id);
        return trainer;
    }

    @Override
    public Trainer findByEmail(String email) {
        List<Trainer> list = jdbcTemplate.query(
                "SELECT * FROM trainers WHERE email = ?",
                mapper,
                email
        );
        return list.isEmpty() ? null : list.get(0);
    }

    @Override
    public Trainer findById(Long id) {
        List<Trainer> list = jdbcTemplate.query(
                "SELECT * FROM trainers WHERE trainer_id = ?",
                mapper,
                id
        );
        return list.isEmpty() ? null : list.get(0);
    }

    @Override
    public List<Trainer> findAll() {
        return jdbcTemplate.query(
                "SELECT * FROM trainers",
                mapper
        );
    }

    @Override
    public void update(Trainer trainer) {
        String sql = "UPDATE trainers SET name=?, contact=?, experience=?, skills=?, profile_pic=?, bio=? "
                   + "WHERE trainer_id=?";

        jdbcTemplate.update(sql,
                trainer.getName(),
                trainer.getContact(),
                trainer.getExperience(),
                trainer.getSkills(),
                trainer.getProfilePic(),
                trainer.getBio(),
                trainer.getTrainerId()
        );
    }

    @Override
    public void deleteById(Long id) {
        jdbcTemplate.update(
                "DELETE FROM trainers WHERE trainer_id = ?",
                id
        );
    }
    
    @Override
    public void deleteByEmail(String email) {
        jdbcTemplate.update("DELETE FROM trainers WHERE email = ?", email);
    }
}
package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.User;
import com.finalproject.internMgmtSystem.repository.UserDao;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.stereotype.Repository;

import java.sql.Types;
import java.util.List;

@Repository
public class UserDaoImpl implements UserDao {

	@Autowired
	private JdbcTemplate jdbcTemplate;

	private RowMapper<User> mapper = (rs, rowNum) -> {
		User u = new User();
		u.setUserId(rs.getLong("user_id"));
		u.setUserName(rs.getString("user_name"));
		u.setEmail(rs.getString("email"));
		u.setPassword(rs.getString("password"));
		u.setDob(rs.getDate("dob"));
		u.setContactNo(rs.getString("contact_no"));
		u.setAddress(rs.getString("address"));
		u.setCollegeName(rs.getString("college_name"));
		u.setGrade(rs.getString("grade"));
		u.setMajor(rs.getString("major"));
		u.setTeam(rs.getString("team"));
		u.setBatchCode(rs.getLong("batch_code"));
		u.setStartDate(rs.getDate("start_date"));
		u.setEndDate(rs.getDate("end_date"));
		u.setGraduatingYear(rs.getInt("graduating_year"));
		u.setResume(rs.getString("resume"));
		u.setProfilePic(rs.getString("profile_pic"));
		u.setRole(rs.getString("role"));
		u.setCreatedAt(rs.getTimestamp("created_at"));
		return u;
	};

	@Override
	public User save(User user) {
		String sql = """
				INSERT INTO users
				(user_name, email, password, dob, contact_no, address, college_name, grade, major,
				team, batch_code, start_date, end_date, graduating_year, resume, profile_pic, role)
				VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
				""";

		jdbcTemplate.update(sql, user.getUserName(), user.getEmail(), user.getPassword(), user.getDob(),
				user.getContactNo(), user.getAddress(), user.getCollegeName(), user.getGrade(), user.getMajor(),
				user.getTeam(), user.getBatchCode(), user.getStartDate(), user.getEndDate(), user.getGraduatingYear(),
				user.getResume(), user.getProfilePic(), user.getRole());

		Long id = jdbcTemplate.queryForObject("SELECT LAST_INSERT_ID()", Long.class);
		user.setUserId(id);
		return user;
	}

	@Override
	public User findByEmail(String email) {
		List<User> list = jdbcTemplate.query("SELECT * FROM users WHERE email = ?", mapper, email);
		return list.isEmpty() ? null : list.get(0);
	}

	@Override
	public User findById(Long id) {
		List<User> list = jdbcTemplate.query("SELECT * FROM users WHERE user_id = ?", mapper, id);
		return list.isEmpty() ? null : list.get(0);
	}

	@Override
	public List<User> findAll() {
		return jdbcTemplate.query("SELECT * FROM users", mapper);
	}

	@Override
	public void update(User user) {
		String sql = """
				    UPDATE users SET user_name=?, contact_no=?, address=?, college_name=?, grade=?, major=?,
				    team=?, start_date=?, end_date=?, graduating_year=?, resume=?, profile_pic=? WHERE user_id=?
				""";

		jdbcTemplate.update(sql, user.getUserName(), user.getContactNo(), user.getAddress(), user.getCollegeName(),
				user.getGrade(), user.getMajor(), user.getTeam(), user.getBatchCode(), user.getStartDate(),
				user.getEndDate(), user.getGraduatingYear(), user.getResume(), user.getProfilePic(), user.getUserId());
	}

	@Override
	public void deleteById(Long id) {
		jdbcTemplate.update("DELETE FROM users WHERE user_id = ?", id);
	}
}

package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.Trainer;
import java.util.List;

public interface TrainerDao {

    Trainer save(Trainer trainer);

    Trainer findByEmail(String email);

    Trainer findById(Long id);

    List<Trainer> findAll();

    void update(Trainer trainer);

    void deleteById(Long id);

    void deleteByEmail(String email);
}


package com.finalproject.internMgmtSystem.repository;

import com.finalproject.internMgmtSystem.model.User;
import java.util.List;

public interface UserDao {

    User save(User user);

    User findByEmail(String email);

    User findById(Long id);

    List<User> findAll();

    void update(User user);

    void deleteById(Long id);
}

